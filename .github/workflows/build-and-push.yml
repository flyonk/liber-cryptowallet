name: deploy-dev
on:
  push:
    branches:
      - 'dev'
#      - 'master'
#    tags:
#      - '**'
jobs:
  build-push-and-deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@master
      - name: helm lint
        run: helm lint provisioning/liber-app
      - name: Set outputs
        id: version
        run: |
          if [[ ${{ github.ref_type }} == 'tag' ]]; then
            TAG=${{ github.ref_name }}
          else
            TAG="commit-$(git rev-parse --short HEAD)"
          fi
          echo "::set-output name=tag::${TAG}"
      - name: Kaniko build
        uses: aevea/action-kaniko@v0.6.2
        env:
          ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
        with:
          image: ${{ github.repository_owner }}/liber-app
          tag: ${{ steps.version.outputs.tag }}
          registry: ghcr.io
          password: ${{ secrets.GITHUB_TOKEN }}
          extra_args: |
            --build-arg VERSION=${{ steps.version.outputs.tag }} 
            --build-arg GITHUB_TOKEN=${{ secrets.ACCESS_TOKEN }}
            --build-arg NPM_TOKEN=${{ secrets.NPM_TOKEN }}
      - name: resolve k8s kubeconfig
        id: k8s
        run: |
          echo "::set-output name=kubeconfig::/root/.kube/config-dev"
      - name: deploy
        run: |
          helm --kubeconfig=${{ steps.k8s.outputs.kubeconfig }} upgrade --install liber-app ./provisioning/liber-app \
          --debug --namespace=frontend \
          --values=./provisioning/liber-app/values.yaml \
          --values=./provisioning/liber-app/values.dev.yaml \
          --set image.tag=${{ steps.version.outputs.tag }}
      - name: autotests
        run: |
               curl -XPOST -u "${{ secrets.GITHUB_USERNAME}}:${{secrets.GITHUB_TOKEN}}" -H "Accept:application/vnd.github" -H "Content-Type:application/json" https://github.com/cryptowize-tech/liber-app-autotests/actions/workflows/autotest.yml/dispatches --data '{"ref": "main" }'


